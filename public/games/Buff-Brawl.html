<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>

    <!-- Primary Meta Tags -->
    <title>Buff Brawl: Arena Mode | Andy's Epic Gaming Zone</title>
    <meta name='title' content='Buff Brawl: Arena Mode'>
    <meta name='description'
        content='Survive the arena in this intense brawler! Defeat waves of enemies and bosses in Buff Brawl.'>
    <meta name='keywords' content='buff brawl, fighting game, arena survival, beat em up, action game, browser game'>
    <meta name='robots' content='index, follow'>
    <meta name='language' content='English'>
    <meta name='author' content='Andy Fitzgerald'>

    <!-- Open Graph / Facebook -->
    <meta property='og:type' content='website'>
    <meta property='og:url' content='https://andy-fitzgerald.com/games/Buff-Brawl.html'>
    <meta property='og:title' content='Buff Brawl: Arena Mode'>
    <meta property='og:description'
        content='Survive the arena in this intense brawler! Defeat waves of enemies and bosses in Buff Brawl.'>
    <meta property='og:image' content='https://andy-fitzgerald.com/images/andy_my529.png'>
    <meta property='og:site_name' content='Andy\' s Epic Gaming Zone'>

    <!-- Twitter -->
    <meta property='twitter:card' content='summary_large_image'>
    <meta property='twitter:url' content='https://andy-fitzgerald.com/games/Buff-Brawl.html'>
    <meta property='twitter:title' content='Buff Brawl: Arena Mode'>
    <meta property='twitter:description'
        content='Survive the arena in this intense brawler! Defeat waves of enemies and bosses in Buff Brawl.'>
    <meta property='twitter:image' content='https://andy-fitzgerald.com/images/andy_my529.png'>

    <!-- Favicon -->
    <link rel='icon' type='image/png' href='/favicon.png'>
    <link rel='apple-touch-icon' href='/favicon.png'>

    <!-- Canonical URL -->
    <link rel='canonical' href='https://andy-fitzgerald.com/games/Buff-Brawl.html'>

    <!-- Stylesheets -->
    <link rel='stylesheet' href='../css/styles.css'>

    <!-- Structured Data -->
    <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Game",
    "name": "Buff Brawl",
    "description": "Survive the arena in this intense brawler! Defeat waves of enemies and bosses.",
    "url": "https://andy-fitzgerald.com/games/Buff-Brawl.html",
    "genre": "Action",
    "gamePlatform": "Web Browser",
    "operatingSystem": "Any",
    "applicationCategory": "Game",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "author": {
      "@type": "Person",
      "name": "Andy Fitzgerald"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Andy's Epic Gaming Zone",
      "url": "https://andy-fitzgerald.com"
    },
    "isPartOf": {
      "@type": "WebSite",
      "name": "Andy's Epic Gaming Zone",
      "url": "https://andy-fitzgerald.com"
    }
  }
  </script>
    <style>
        :root {
            --primary-color: #4ecdc4;
            --secondary-color: #45b7aa;
            --accent-color: #96ceb4;
            --text-color: #ffffff;
            --bg-dark: #2c3e50;
            --bg-darker: #1a252f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-darker) 0%, var(--bg-dark) 100%);
            color: var(--text-color);
            min-height: 100vh;
            overflow-x: hidden;
            user-select: none;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .back-button:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .game-header {
            text-align: center;
            padding: 2rem 1rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 2rem;
        }

        .game-header h1 {
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .main-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            min-height: calc(100vh - 200px);
            padding: 0 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .game-container {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 2px solid var(--primary-color);
            max-width: 850px;
            /* Slightly wider for this game */
            width: 100%;
            flex: 0 0 auto;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            border: 2px solid var(--primary-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            text-align: center;
            height: fit-content;
        }

        .sidebar-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .donate-link {
            display: inline-block;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .donate-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .game-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .info-item {
            background: rgba(78, 205, 196, 0.1);
            padding: 0.75rem;
            border-radius: 10px;
            border: 1px solid var(--primary-color);
            font-weight: bold;
        }

        .game-canvas {
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            background: #222;
            display: block;
            margin: 0 auto 1.5rem;
            box-shadow: 0 0 30px rgba(78, 205, 196, 0.3);
            outline: none;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .game-button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(78, 205, 196, 0.3);
        }

        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
        }

        .instructions {
            background: rgba(0, 0, 0, 0.3);
            padding: 1.5rem;
            border-radius: 10px;
            border: 1px solid var(--primary-color);
            text-align: center;
        }

        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .instructions p {
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .game-start,
        .game-over {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--primary-color);
            z-index: 150;
            min-width: 300px;
            box-shadow: 0 0 50px rgba(78, 205, 196, 0.5);
        }

        .game-start h2,
        .game-over h2 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }

        /* Buff Brawl Specific Styles */
        .key-badge {
            background: #fff;
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            margin: 0 2px;
            font-size: 14px;
        }

        /* Leaderboard Styles */
        .leaderboard {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--primary-color);
            display: none;
            z-index: 200;
            min-width: 400px;
            max-width: 90vw;
            box-shadow: 0 0 50px rgba(78, 205, 196, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .leaderboard h2 {
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-shadow: 0 0 10px var(--primary-color);
        }

        .leaderboard-list {
            margin: 1rem 0;
            text-align: left;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 5px;
            border-left: 3px solid var(--primary-color);
        }

        .leaderboard-entry.new-score {
            background: rgba(255, 170, 0, 0.2);
            border-left-color: #ffaa00;
            animation: glow 2s ease-in-out infinite alternate;
        }

        .high-score-input {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffaa00;
            z-index: 300;
            min-width: 350px;
            box-shadow: 0 0 50px rgba(255, 170, 0, 0.5);
            display: none;
        }

        .high-score-input h2 {
            color: #ffaa00;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px #ffaa00;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
            }

            to {
                box-shadow: 0 0 20px rgba(78, 205, 196, 0.8);
            }
        }

        #health-container {
            width: 100%;
            height: 20px;
            background: #444;
            border: 2px solid white;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        #health-bar {
            width: 100%;
            height: 100%;
            background: #e74c3c;
            transition: width 0.2s;
        }

        #boss-health-container {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 30px;
            background: #000;
            border: 3px solid #ff0000;
            display: none;
            z-index: 10;
            border-radius: 5px;
        }

        #boss-health-bar {
            width: 100%;
            height: 100%;
            background: #800000;
            transition: width 0.2s;
        }

        #boss-name {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            color: #fff;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 #000;
        }

        @media (max-width: 1200px) {
            .sidebar {
                display: none;
            }

            .main-wrapper {
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .game-header h1 {
                font-size: 2rem;
            }

            .game-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <a href="../index.html" class="back-button">üè† Back to Gaming Zone</a>

    <div class="game-header">
        <h1>ü•ä BUFF BRAWL ü•ä</h1>
    </div>

    <div class="main-wrapper">
        <div class="game-container">

            <div class="game-info">
                <div class="info-item">
                    KILLS: <span id="kill-count">0</span> / 500
                </div>
                <div class="info-item">
                    HIGH SCORE: <span id="high-score">0</span>
                </div>
                <div class="info-item">
                    HEALTH
                    <div id="health-container">
                        <div id="health-bar"></div>
                    </div>
                </div>
            </div>

            <!-- Boss UI Overlay -->
            <div id="boss-health-container">
                <div id="boss-name">THE BUFF BOSS</div>
                <div id="boss-health-bar"></div>
            </div>

            <canvas id="gameCanvas" class="game-canvas" width="800" height="600" tabindex="0"></canvas>

            <div class="controls">
                <button class="game-button" onclick="startGame()">üéÆ START GAME</button>
                <button class="game-button" onclick="resetGame()">üîÑ RESET</button>
                <button class="game-button" onclick="showLeaderboard()">üèÜ LEADERBOARD</button>
            </div>

            <div class="instructions">
                <h3>ü•ä INSTRUCTIONS</h3>

                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--accent-color); margin-bottom: 0.5rem;">üéØ OBJECTIVE</h4>
                    <p>Survive the arena! Defeat <strong>500 enemies</strong> to summon <strong>THE BUFF BOSS</strong>.
                        Defeat the boss to claim victory!</p>
                </div>

                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--accent-color); margin-bottom: 0.5rem;">üë• CHARACTERS</h4>
                    <p>üí™ <strong>The Buff One:</strong> That's you! Maximum gains.</p>
                    <p>üßü <strong>Sick Figures:</strong> Weak enemies. Don't let them touch you!</p>
                    <p>üëπ <strong>The Buff Boss:</strong> The ultimate challenge.</p>
                </div>

                <div>
                    <h4 style="color: var(--accent-color); margin-bottom: 0.5rem;">ü•ä MOVES & CONTROLS</h4>
                    <p><span class="key-badge">ARROWS</span> Move / Jump</p>
                    <p><span class="key-badge">Z</span> JAB | <span class="key-badge">X</span> CROSS | <span
                            class="key-badge">C</span> UPPERCUT</p>
                    <p><span class="key-badge">DOWN</span> + <span class="key-badge">Z</span> SWEEP / POUND</p>
                    <p><span class="key-badge">UP</span> (Hold) MONKEY BAR</p>
                </div>
            </div>
        </div>

        <!-- Right Sidebar Column -->
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- Top Sidebar Box -->
            <div class="sidebar">
                <img src="../images/andy_my529.png" alt="Andy's 529 Plan" class="sidebar-image">
                <a href="https://gift.my529.org/LPXR40" target="_blank" class="donate-link">Donate to Andy</a>
            </div>

            <!-- Bottom Sidebar Box (Moved from Left) -->
            <div class="sidebar">
                <img src="../images/andy_my529.png" alt="Andy's 529 Plan" class="sidebar-image">
                <a href="https://gift.my529.org/LPXR40" target="_blank" class="donate-link">Donate to Andy</a>
            </div>
        </div>
    </div>

    <div class="game-start" id="gameStart">
        <h2>ü•ä BUFF BRAWL ü•ä</h2>
        <p>ARENA SURVIVAL MODE</p>
        <p>Defeat 500 enemies to face the BOSS!</p>
        <button class="game-button" onclick="startGame()">üéÆ FIGHT!</button>
    </div>

    <div class="game-over" id="gameOver" style="display: none;">
        <h2 id="go-title">GAME OVER</h2>
        <p>Enemies Defeated: <span id="final-score">0</span></p>
        <p style="color: #f1c40f; font-size: 18px; margin-top: 5px;" id="new-highscore-msg"></p>
        <button class="game-button" onclick="resetGame()">üîÑ PLAY AGAIN</button>
        <button class="game-button" onclick="showLeaderboard()">üèÜ LEADERBOARD</button>
    </div>

    <!-- Leaderboard Modal -->
    <div class="leaderboard" id="leaderboard">
        <h2>üèÜ BUFF BRAWL LEADERBOARD üèÜ</h2>
        <div class="leaderboard-list" id="leaderboardList">
            <!-- Leaderboard entries will be populated here -->
        </div>
        <button class="game-button" onclick="hideLeaderboard()">‚úñÔ∏è CLOSE</button>
    </div>

    <!-- High Score Input Modal -->
    <div class="high-score-input" id="highScoreInput">
        <h2>üèÜ NEW HIGH SCORE! üèÜ</h2>
        <p>Congratulations! You made it to the leaderboard!</p>
        <p>Kills: <span id="newHighScore">0</span></p>
        <input type="text" id="playerName" placeholder="Enter your name" maxlength="15"
            style="padding: 0.5rem; margin: 1rem; border-radius: 5px; border: 1px solid #4ecdc4; background: rgba(0,0,0,0.8); color: white; text-align: center;">
        <br>
        <button class="game-button" onclick="submitScore()">üèÜ SUBMIT SCORE</button>
    </div>

    <script>
        /**
         * AUDIO SYSTEM
         */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let soundEnabled = false;

        function playSound(type) {
            if (!soundEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;

            if (type === 'jump') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(300, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'whoosh') {
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'hit') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, now);
                osc.frequency.exponentialRampToValueAtTime(0.01, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(now);
                osc.stop(now + 0.1);
            } else if (type === 'heavy_hit') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(80, now);
                osc.frequency.exponentialRampToValueAtTime(10, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            }
        }

        /**
         * Game Constants & Setup
         */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Fixed size for template
        const WIDTH = 800;
        const HEIGHT = 600;

        let gameState = 'start'; // Changed from 'menu' to match template flow
        let kills = 0;
        let totalSpawned = 0;
        let bossSpawned = false;
        let bossDefeated = false;

        const TOTAL_ENEMIES = 500;
        const MAX_ACTIVE_ENEMIES = 40;
        const GRAVITY = 0.6;

        // World Arrays
        const platforms = [];
        const ladders = [];
        const monkeyBars = [];

        // High Score Logic
        let highScore = localStorage.getItem('buffBrawlHighScore') || 0;
        document.getElementById('high-score').innerText = highScore;

        // Initial setup
        canvas.width = WIDTH;
        canvas.height = HEIGHT;
        generateLevel();

        // Inputs
        const keys = {
            left: false, right: false, up: false, down: false,
            jump: false, attack1: false, attack2: false, attack3: false
        };

        canvas.addEventListener('keydown', handleKey);
        canvas.addEventListener('keyup', handleKeyRelease);
        window.addEventListener('keydown', handleKey); // Keep window listener for better responsiveness
        window.addEventListener('keyup', handleKeyRelease);

        function handleKey(e) {
            if (gameState !== 'playing') return;
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space'].includes(e.code)) e.preventDefault();

            switch (e.code) {
                case 'ArrowLeft': case 'KeyA': keys.left = true; break;
                case 'ArrowRight': case 'KeyD': keys.right = true; break;
                case 'ArrowUp': case 'KeyW': keys.up = true; break;
                case 'ArrowDown': case 'KeyS': keys.down = true; break;
                case 'Space': case 'KeyZ':
                    if (!keys.attack1 && player) player.tryAttack('jab');
                    keys.attack1 = true; break;
                case 'KeyX':
                    if (!keys.attack2 && player) player.tryAttack('cross');
                    keys.attack2 = true; break;
                case 'KeyC': case 'KeyV':
                    if (!keys.attack3 && player) player.tryAttack('uppercut');
                    keys.attack3 = true; break;
            }
        }

        function handleKeyRelease(e) {
            switch (e.code) {
                case 'ArrowLeft': case 'KeyA': keys.left = false; break;
                case 'ArrowRight': case 'KeyD': keys.right = false; break;
                case 'ArrowUp': case 'KeyW': keys.up = false; break;
                case 'ArrowDown': case 'KeyS': keys.down = false; break;
                case 'Space': case 'KeyZ': keys.attack1 = false; break;
                case 'KeyX': keys.attack2 = false; break;
                case 'KeyC': case 'KeyV': keys.attack3 = false; break;
            }
        }

        function generateLevel() {
            platforms.length = 0;
            ladders.length = 0;
            monkeyBars.length = 0;
            platforms.push({ x: -100, y: HEIGHT - 50, w: WIDTH + 200, h: 200 });
            const sidePlatWidth = WIDTH * 0.25;
            const midHeight = HEIGHT - 200;
            platforms.push({ x: 0, y: midHeight, w: sidePlatWidth, h: 20 });
            ladders.push({ x: sidePlatWidth / 2, y: midHeight, w: 40, h: HEIGHT - 50 - midHeight });
            platforms.push({ x: WIDTH - sidePlatWidth, y: midHeight, w: sidePlatWidth, h: 20 });
            ladders.push({ x: WIDTH - sidePlatWidth / 2, y: midHeight, w: 40, h: HEIGHT - 50 - midHeight });
            const centerW = WIDTH * 0.2;
            const topHeight = midHeight - 150;
            platforms.push({ x: (WIDTH - centerW) / 2, y: topHeight, w: centerW, h: 20 });
            monkeyBars.push({ x: sidePlatWidth, y: topHeight + 50, w: (WIDTH - centerW) / 2 - sidePlatWidth, h: 10 });
            monkeyBars.push({ x: (WIDTH + centerW) / 2, y: topHeight + 50, w: (WIDTH - centerW) / 2 - sidePlatWidth, h: 10 });
            monkeyBars.push({ x: WIDTH * 0.3, y: topHeight - 100, w: WIDTH * 0.4, h: 10 });
        }

        class Entity {
            constructor(x, y, isPlayer = false) {
                this.x = x;
                this.y = y;
                this.vx = 0;
                this.vy = 0;
                this.isPlayer = isPlayer;
                this.isBoss = false;

                this.width = isPlayer ? 50 : 30;
                this.height = isPlayer ? 100 : 70;
                this.speed = isPlayer ? 8 : 2 + Math.random();
                this.jumpPower = -15;
                this.color = isPlayer ? '#ecf0f1' : '#2ecc71';

                this.maxHealth = isPlayer ? 10000 : 30;
                this.health = this.maxHealth;

                this.attackCooldown = 0;
                this.isAttacking = false;
                this.currentAttackType = 'none';
                this.attackFrame = 0;
                this.damage = 10;

                this.facing = 1;
                this.hitStun = 0;
                this.grounded = false;
                this.onLadder = false;
                this.climbing = false;
                this.hanging = false;
                this.dead = false;
                this.fadeAlpha = 1.0;
            }

            update() {
                if (this.dead) {
                    this.fadeAlpha -= 0.05;
                    return;
                }

                if (this.hitStun > 0) {
                    this.hitStun--;
                    this.vx *= 0.8;
                    this.applyPhysics();
                    return;
                }

                if (this.isPlayer) {
                    this.handlePlayerInput();
                } else {
                    this.handleAI();
                }

                this.applyPhysics();
                this.handleCombat();
            }

            handlePlayerInput() {
                if (this.hanging) {
                    this.vx = 0;
                    this.vy = 0;
                    if (keys.left) { this.x -= 4; this.facing = -1; }
                    if (keys.right) { this.x += 4; this.facing = 1; }
                    if (keys.down) { this.hanging = false; this.y += 10; }
                } else if (this.climbing) {
                    this.vx = 0;
                    this.vy = 0;
                    if (keys.up) this.vy = -5;
                    if (keys.down) this.vy = 5;
                    if (keys.left) this.x -= 2;
                    if (keys.right) this.x += 2;
                } else {
                    if (keys.left) { this.vx = -this.speed; this.facing = -1; }
                    else if (keys.right) { this.vx = this.speed; this.facing = 1; }
                    else { this.vx *= 0.6; }
                    if (keys.up && this.grounded) {
                        this.vy = this.jumpPower;
                        this.grounded = false;
                        if (this.isPlayer) playSound('jump');
                    }
                }
                this.checkInteractables();
            }

            handleAI() {
                if (this.isBoss) {
                    // BOSS AI
                    const dist = player.x - this.x;
                    const distY = player.y - this.y;
                    const attackRange = 80;

                    if (Math.abs(dist) > attackRange - 20) {
                        this.vx = (dist > 0 ? 1 : -1) * this.speed;
                        this.facing = (dist > 0 ? 1 : -1);
                    } else {
                        this.vx = 0;
                        this.facing = (dist > 0 ? 1 : -1);
                    }

                    if ((distY < -100 || (Math.abs(this.vx) < 1 && Math.abs(dist) > 100)) && this.grounded) {
                        this.vy = this.jumpPower;
                        this.grounded = false;
                    }

                    if (Math.abs(dist) < attackRange + 20 && Math.abs(distY) < 100) {
                        if (Math.random() < 0.05 && this.attackCooldown <= 0) {
                            const r = Math.random();
                            if (r < 0.4) this.tryAttack('jab');
                            else if (r < 0.8) this.tryAttack('cross');
                            else if (r < 0.95) this.tryAttack('uppercut');
                            else this.tryAttack('pound');
                        }
                    }
                } else {
                    // ENEMY AI
                    const dist = player.x - this.x;
                    const attackRange = 50;
                    if (Math.abs(dist) > attackRange) {
                        this.vx = (dist > 0 ? 1 : -1) * this.speed;
                        this.facing = (dist > 0 ? 1 : -1);
                    } else {
                        this.vx = 0;
                        if (Math.random() < 0.02) this.tryAttack('jab');
                    }
                    if (Math.random() < 0.01 && this.grounded) {
                        this.vy = this.jumpPower;
                        this.grounded = false;
                    }
                }
            }

            checkInteractables() {
                let touchingLadder = false;
                let ladderInstance = null;
                for (let l of ladders) {
                    if (this.x + this.width / 2 > l.x - l.w / 2 && this.x - this.width / 2 < l.x + l.w / 2 && this.y > l.y && this.y < l.y + l.h) {
                        touchingLadder = true;
                        ladderInstance = l;
                        break;
                    }
                }
                if (touchingLadder) {
                    if (this.isPlayer) {
                        if (!this.climbing && !this.hanging && (keys.up || keys.down)) {
                            this.climbing = true; this.x = ladderInstance.x; this.vx = 0;
                        }
                    }
                } else {
                    this.climbing = false;
                }

                if (!this.grounded && !this.climbing) {
                    let touchingBar = false;
                    let barY = 0;
                    for (let b of monkeyBars) {
                        if (this.x > b.x && this.x < b.x + b.w && this.y > b.y && this.y < b.y + 40) {
                            touchingBar = true; barY = b.y; break;
                        }
                    }
                    if (touchingBar && keys.up && this.vy > 0 && this.isPlayer) {
                        this.hanging = true; this.y = barY + 40; this.vy = 0;
                    }
                    if (this.hanging && !touchingBar) this.hanging = false;
                }
            }

            applyPhysics() {
                if (!this.climbing && !this.hanging) this.vy += GRAVITY;
                this.x += this.vx;
                this.y += this.vy;
                this.grounded = false;
                if (this.vy >= 0 && !this.climbing && !this.hanging) {
                    for (let p of platforms) {
                        if (this.x > p.x && this.x < p.x + p.w && this.y >= p.y && this.y <= p.y + this.vy + 2) {
                            this.y = p.y; this.vy = 0; this.grounded = true;
                        }
                    }
                }
                if (this.y > HEIGHT + 100) this.takeDamage(999);
                if (this.x < 0) this.x = 0;
                if (this.x > WIDTH) this.x = WIDTH;
            }

            tryAttack(type) {
                if (this.attackCooldown <= 0 && !this.hanging && !this.climbing) {
                    if (this.isPlayer) {
                        if (keys.down && type === 'jab') type = this.grounded ? 'sweep' : 'pound';
                        else if (type === 'jab' && keys.up) type = 'uppercut';
                    }

                    this.isAttacking = true;
                    this.currentAttackType = type;
                    if (this.isPlayer || this.isBoss) playSound('whoosh');

                    if (type === 'jab') {
                        this.attackFrame = 10; this.attackCooldown = 15; this.damage = (this.isPlayer || this.isBoss) ? 25 : 2;
                    } else if (type === 'cross') {
                        this.attackFrame = 15; this.attackCooldown = 25; this.damage = (this.isPlayer || this.isBoss) ? 45 : 4;
                    } else if (type === 'uppercut') {
                        this.attackFrame = 20; this.attackCooldown = 40; this.damage = (this.isPlayer || this.isBoss) ? 100 : 8; this.vy = -5;
                    } else if (type === 'sweep') {
                        this.attackFrame = 15; this.attackCooldown = 30; this.damage = 30; this.vx = this.facing * 10;
                    } else if (type === 'pound') {
                        this.attackFrame = 30; this.attackCooldown = 50;
                        this.damage = 50;
                        this.vy = 20; this.vx = 0;
                    }
                }
            }

            handleCombat() {
                if (this.attackCooldown > 0) this.attackCooldown--;
                if (this.currentAttackType === 'pound' && !this.grounded) {
                    this.attackFrame = 2; this.isAttacking = true;
                }

                if (this.isAttacking) {
                    this.attackFrame--;
                    if (this.attackFrame <= 0) this.isAttacking = false;

                    let rangeMult = 1;
                    let yRange = 90;
                    let yOffset = this.height / 2;

                    if (this.currentAttackType === 'uppercut') { yRange = 150; rangeMult = 0.8; }
                    if (this.currentAttackType === 'cross') rangeMult = 1.5;
                    if (this.currentAttackType === 'sweep') { yOffset = this.height - 20; yRange = 40; }
                    if (this.currentAttackType === 'pound') { rangeMult = 2.0; yRange = 100; yOffset = this.height; }

                    const hitRange = ((this.isPlayer || this.isBoss) ? 100 : 40) * rangeMult;
                    const hitX = this.x + (this.facing * 40);
                    const hitY = this.y - yOffset;
                    const targets = this.isPlayer ? enemies : [player];

                    targets.forEach(target => {
                        if (!target.dead && Math.abs(target.x - hitX) < hitRange && Math.abs(target.y - hitY - target.height / 2) < yRange) {
                            let kY = -5; let kX = 5;
                            if (this.currentAttackType === 'uppercut') { kY = -25; kX = 2; }
                            else if (this.currentAttackType === 'cross') { kY = -8; kX = 20; }
                            else if (this.currentAttackType === 'sweep') { kY = -15; kX = 2; }
                            else if (this.currentAttackType === 'pound') { kY = -10; kX = 15; }

                            target.takeDamage(this.damage, this.facing, kX, kY);
                            if (this.currentAttackType !== 'pound') this.isAttacking = false;
                        }
                    });

                    if (this.currentAttackType === 'pound' && this.grounded) {
                        if (this.isPlayer || this.isBoss) {
                            shakeScreen(20); playSound('heavy_hit');
                        }
                        this.isAttacking = false;
                    }
                }
            }

            takeDamage(amount, direction = 1, kX = 5, kY = -5) {
                if (this.dead) return;
                this.health -= amount;
                this.hitStun = 10;
                this.vy = kY;
                this.vx = direction * kX;

                createParticles(this.x, this.y - this.height / 2, this.isPlayer ? '#fff' : (this.isBoss ? '#000' : '#2ecc71'));

                if (this.isPlayer || this.isBoss) playSound('hit');
                else playSound('hit');

                if (this.isPlayer) {
                    updateHealthBar(); shakeScreen(5);
                } else if (this.isBoss) {
                    updateBossHealthBar(); shakeScreen(5);
                }

                if (this.health <= 0) {
                    this.dead = true;
                    if (this.isPlayer) {
                        gameOver(false);
                    } else if (this.isBoss) {
                        bossDefeated = true;
                        kills++;
                        document.getElementById('kill-count').innerText = "BOSS DEFEATED";
                        gameOver(true);
                    } else {
                        kills++;
                        document.getElementById('kill-count').innerText = kills;
                        this.vx = direction * (kX + 5);
                        this.vy = kY - 5;
                    }
                }
            }

            draw() {
                if (this.dead && this.fadeAlpha <= 0) return;
                ctx.save();
                if (this.dead && !this.isPlayer) {
                    this.x += this.vx; this.y += this.vy; this.vy += GRAVITY;
                    ctx.globalAlpha = this.fadeAlpha;
                }

                ctx.translate(this.x, this.y);
                ctx.scale(this.facing, 1);

                const sway = Math.sin(Date.now() / 150) * 2;
                const runCycle = Math.sin(Date.now() / (this.isPlayer || this.isBoss ? 50 : 100)) * 10;

                ctx.strokeStyle = this.color;
                ctx.fillStyle = this.color;
                ctx.lineCap = "round"; ctx.lineJoin = "round";

                if (this.isPlayer || this.isBoss) {
                    // BUFF BODY (Player or Boss)
                    ctx.lineWidth = 6;
                    // Legs
                    if (this.grounded && Math.abs(this.vx) > 0.1) {
                        ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(-15 + runCycle, 0); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(15 - runCycle, 0); ctx.stroke();
                    } else if (this.currentAttackType === 'sweep') {
                        ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(40, 0); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(-20, 0); ctx.stroke();
                    } else {
                        ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(-15, 0); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(15, 0); ctx.stroke();
                    }
                    // Body
                    ctx.beginPath(); ctx.moveTo(0, -40); ctx.lineTo(-15, -90); ctx.lineTo(15, -90); ctx.lineTo(0, -40); ctx.fill();
                    // Head
                    ctx.beginPath(); ctx.arc(0, -100, 10, 0, Math.PI * 2); ctx.fill();

                    // Arms
                    if (this.isAttacking) {
                        ctx.lineWidth = 8;
                        if (this.currentAttackType === 'jab') {
                            ctx.beginPath(); ctx.moveTo(-10, -90); ctx.lineTo(60, -90); ctx.stroke();
                            ctx.beginPath(); ctx.arc(65, -90, 8, 0, Math.PI * 2); ctx.fill();
                            ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(10, -90); ctx.lineTo(20, -70); ctx.lineTo(30, -80); ctx.stroke();
                        } else if (this.currentAttackType === 'cross') {
                            ctx.beginPath(); ctx.moveTo(10, -90); ctx.lineTo(80, -90); ctx.stroke();
                            ctx.beginPath(); ctx.arc(85, -90, 9, 0, Math.PI * 2); ctx.fill();
                            ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(-10, -90); ctx.lineTo(0, -70); ctx.lineTo(10, -80); ctx.stroke();
                        } else if (this.currentAttackType === 'uppercut') {
                            ctx.beginPath(); ctx.moveTo(10, -90); ctx.lineTo(15, -160); ctx.stroke();
                            ctx.beginPath(); ctx.arc(15, -165, 12, 0, Math.PI * 2); ctx.fill();
                            ctx.lineWidth = 5; ctx.beginPath(); ctx.moveTo(-10, -90); ctx.lineTo(-20, -70); ctx.stroke();
                        } else if (this.currentAttackType === 'pound') {
                            ctx.beginPath(); ctx.moveTo(-10, -90); ctx.lineTo(-10, 10); ctx.stroke();
                            ctx.beginPath(); ctx.arc(-10, 15, 10, 0, Math.PI * 2); ctx.fill();
                            ctx.beginPath(); ctx.moveTo(10, -90); ctx.lineTo(10, 10); ctx.stroke();
                            ctx.beginPath(); ctx.arc(10, 15, 10, 0, Math.PI * 2); ctx.fill();
                        }
                    } else if (this.climbing || this.hanging) {
                        ctx.lineWidth = 5;
                        ctx.beginPath(); ctx.moveTo(-15, -90); ctx.lineTo(-15, -120); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(15, -90); ctx.lineTo(15, -120); ctx.stroke();
                    } else {
                        ctx.lineWidth = 5;
                        ctx.beginPath(); ctx.moveTo(-15, -90); ctx.lineTo(-25, -60); ctx.lineTo(-10, -50); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(15, -90); ctx.lineTo(25, -60); ctx.lineTo(35, -70); ctx.stroke();
                    }
                } else {
                    // SICK/WEAK BODY
                    ctx.lineWidth = 3; ctx.strokeStyle = '#6ab04c';
                    ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(-10 + (this.vx ? runCycle : 0), 0); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, -30); ctx.lineTo(10 - (this.vx ? runCycle : 0), 0); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(0, -30); ctx.quadraticCurveTo(5, -45, 2, -60); ctx.stroke();
                    ctx.beginPath(); ctx.arc(2, -65, 6, 0, Math.PI * 2); ctx.stroke();
                    if (this.isAttacking) {
                        ctx.beginPath(); ctx.moveTo(2, -55); ctx.lineTo(25, -55); ctx.stroke();
                    } else {
                        ctx.beginPath(); ctx.moveTo(2, -55); ctx.lineTo(15, -40); ctx.stroke();
                    }
                }
                ctx.restore(); ctx.globalAlpha = 1.0;
            }
        }

        let player;
        let enemies = [];
        let particles = [];
        let shake = 0;

        function startGame() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            soundEnabled = true;
            document.getElementById('gameStart').style.display = 'none';
            canvas.focus();
            initGame();
        }

        function initGame() {
            generateLevel();
            player = new Entity(WIDTH / 2, HEIGHT - 150, true);
            enemies = [];
            kills = 0;
            totalSpawned = 0;
            bossSpawned = false;
            bossDefeated = false;
            score = 0;
            document.getElementById('kill-count').innerText = '0';
            document.getElementById('new-highscore-msg').innerText = "";
            document.getElementById('boss-health-container').style.display = 'none';
            updateHealthBar();
            gameState = 'playing';
            document.getElementById('gameOver').style.display = 'none';

            // Start loop if not already running
            requestAnimationFrame(loop);
        }

        function spawnBoss() {
            bossSpawned = true;
            document.getElementById('kill-count').innerText = "BOSS FIGHT";
            document.getElementById('boss-health-container').style.display = 'block';

            // Clear any remaining enemies
            enemies = [];

            let boss = new Entity(WIDTH / 2, HEIGHT - 300);
            boss.isBoss = true;
            boss.color = '#000000'; // Black
            boss.maxHealth = 5000;
            boss.health = 5000;
            boss.width = 50;
            boss.height = 100;
            boss.damage = 35;
            boss.speed = 8;
            enemies.push(boss);

            playSound('heavy_hit');
            shakeScreen(20);
        }

        function manageSpawns() {
            if (kills >= TOTAL_ENEMIES) {
                if (!bossSpawned) {
                    spawnBoss();
                }
                return;
            }

            if (totalSpawned < TOTAL_ENEMIES && enemies.length < MAX_ACTIVE_ENEMIES) {
                if (Math.random() < 0.05) {
                    const side = Math.random() > 0.5 ? 1 : -1;
                    let spawnX = side === 1 ? -50 : WIDTH + 50;
                    let spawnY = HEIGHT - 50;
                    if (Math.random() > 0.7) spawnY = HEIGHT - 300;
                    enemies.push(new Entity(spawnX, spawnY));
                    totalSpawned++;
                }
            }
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (enemies[i].dead && enemies[i].fadeAlpha <= 0) {
                    enemies.splice(i, 1);
                }
            }
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 5; i++) {
                particles.push({
                    x: x, y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 15,
                    color: color
                });
            }
        }

        function shakeScreen(amount) {
            shake = amount;
        }

        function updateHealthBar() {
            const pct = Math.max(0, (player.health / player.maxHealth) * 100);
            document.getElementById('health-bar').style.width = pct + '%';
        }

        function updateBossHealthBar() {
            const boss = enemies.find(e => e.isBoss);
            if (boss) {
                const pct = Math.max(0, (boss.health / boss.maxHealth) * 100);
                document.getElementById('boss-health-bar').style.width = pct + '%';
            }
        }

        function gameOver(win) {
            gameState = 'gameover';
            document.getElementById('go-title').innerText = win ? "VICTORY!" : "GAME OVER";
            document.getElementById('final-score').innerText = kills;

            // Check for leaderboard
            const lowestScore = highScores.length < 10 ? 0 : highScores[highScores.length - 1].score;
            if (kills > lowestScore) {
                document.getElementById('newHighScore').innerText = kills;
                document.getElementById('highScoreInput').style.display = 'block';
                document.getElementById('gameOver').style.display = 'none';
                document.getElementById('playerName').focus();
            } else {
                document.getElementById('gameOver').style.display = 'block';
            }

            if (kills > highScore) {
                highScore = kills;
                localStorage.setItem('buffBrawlHighScore', highScore);
                document.getElementById('high-score').innerText = highScore;
            }
        }

        // Leaderboard Logic
        let highScores = [];

        function loadLeaderboard() {
            const saved = localStorage.getItem('buffBrawlLeaderboard_v3');
            if (saved) {
                highScores = JSON.parse(saved);
            } else {
                // Initialize with default scores
                highScores = [
                    { name: 'BUFF MASTER', score: 501, date: new Date().toISOString() },
                    { name: 'GYM RAT', score: 450, date: new Date().toISOString() },
                    { name: 'IRON PUMPER', score: 400, date: new Date().toISOString() },
                    { name: 'PROTEIN SHAKE', score: 350, date: new Date().toISOString() },
                    { name: 'CARDIO KING', score: 300, date: new Date().toISOString() },
                    { name: 'LEG DAY', score: 250, date: new Date().toISOString() },
                    { name: 'BENCH PRESS', score: 200, date: new Date().toISOString() },
                    { name: 'SQUAT SQUAD', score: 150, date: new Date().toISOString() },
                    { name: 'DEADLIFT DIVA', score: 100, date: new Date().toISOString() },
                    { name: 'FLEX FRIDAY', score: 50, date: new Date().toISOString() }
                ];
                localStorage.setItem('buffBrawlLeaderboard_v3', JSON.stringify(highScores));
            }
        }

        loadLeaderboard();

        function showLeaderboard() {
            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';

            highScores.sort((a, b) => b.score - a.score);

            if (highScores.length === 0) {
                list.innerHTML = '<p style="text-align:center;">No scores yet. Be the first!</p>';
            } else {
                highScores.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'leaderboard-entry';

                    const rank = index + 1;
                    let medal = '';
                    if (rank === 1) medal = 'ü•á';
                    else if (rank === 2) medal = 'ü•à';
                    else if (rank === 3) medal = 'ü•â';
                    else medal = `${rank}.`;

                    div.innerHTML = `
                        <span>${medal} ${entry.name}</span>
                        <span>${entry.score} Kills</span>
                    `;
                    list.appendChild(div);
                });
            }

            document.getElementById('leaderboard').style.display = 'block';
        }

        function hideLeaderboard() {
            document.getElementById('leaderboard').style.display = 'none';
        }

        function submitScore() {
            const name = document.getElementById('playerName').value.trim() || 'Anonymous';
            const newScore = { name: name, score: kills, date: new Date().toISOString() };

            highScores.push(newScore);
            highScores.sort((a, b) => b.score - a.score);
            highScores.splice(10); // Keep top 10

            localStorage.setItem('buffBrawlLeaderboard_v3', JSON.stringify(highScores));

            document.getElementById('highScoreInput').style.display = 'none';
            showLeaderboard();

            // Show game over screen after closing leaderboard (optional, or just leave leaderboard open)
            // For now, we leave leaderboard open, user can close it to see game over screen or reset
        }

        function resetGame() {
            initGame();
        }

        function drawBackground() {
            ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0, 0, WIDTH, HEIGHT);
            ctx.fillStyle = '#16213e'; ctx.beginPath(); ctx.moveTo(0, HEIGHT); ctx.lineTo(0, HEIGHT - 200);
            for (let x = 0; x <= WIDTH + 100; x += 100) ctx.lineTo(x, HEIGHT - 300 - Math.sin(x) * 50);
            ctx.lineTo(WIDTH, HEIGHT); ctx.fill();
            ctx.fillStyle = '#0f3460';
            for (let i = 0; i < WIDTH / 200; i++) {
                let x = i * 200 + 50;
                ctx.fillRect(x, HEIGHT - 250, 40, 250);
                ctx.beginPath(); ctx.arc(x + 20, HEIGHT - 280, 60, 0, Math.PI * 2); ctx.fill();
            }
        }

        function drawLevel() {
            ctx.fillStyle = '#535c68'; ctx.strokeStyle = '#95afc0'; ctx.lineWidth = 2;
            platforms.forEach(p => {
                ctx.fillRect(p.x, p.y, p.w, p.h); ctx.strokeRect(p.x, p.y, p.w, p.h);
                ctx.fillStyle = '#2c3e50';
                for (let i = 0; i < p.w; i += 40) ctx.fillRect(p.x + i, p.y, 2, p.h);
                ctx.fillStyle = '#535c68';
            });
            ctx.strokeStyle = '#f39c12'; ctx.lineWidth = 4;
            ladders.forEach(l => {
                const drawX = l.x - l.w / 2;
                ctx.beginPath(); ctx.moveTo(drawX, l.y); ctx.lineTo(drawX, l.y + l.h);
                ctx.moveTo(drawX + l.w, l.y); ctx.lineTo(drawX + l.w, l.y + l.h); ctx.stroke();
                ctx.lineWidth = 2;
                for (let y = l.y; y < l.y + l.h; y += 20) { ctx.beginPath(); ctx.moveTo(drawX, y); ctx.lineTo(drawX + l.w, y); ctx.stroke(); }
            });
            ctx.fillStyle = '#f1c40f';
            monkeyBars.forEach(b => {
                ctx.fillRect(b.x, b.y, b.w, b.h);
                ctx.fillStyle = '#444'; ctx.fillRect(b.x, b.y - 20, 10, 20); ctx.fillRect(b.x + b.w - 10, b.y - 20, 10, 20);
                ctx.fillStyle = '#f1c40f';
            });
        }

        function loop() {
            if (gameState !== 'playing') return;
            manageSpawns();
            ctx.clearRect(0, 0, WIDTH, HEIGHT);
            let shakeX = 0, shakeY = 0;
            if (shake > 0) {
                shakeX = (Math.random() - 0.5) * shake; shakeY = (Math.random() - 0.5) * shake;
                shake *= 0.9; if (shake < 0.5) shake = 0;
            }
            ctx.save();
            ctx.translate(-shakeX, -shakeY);
            drawBackground();
            drawLevel();
            player.update();
            player.draw();
            enemies.forEach((e) => { e.update(); e.draw(); });
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--;
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4);
                if (p.life <= 0) particles.splice(i, 1);
            }
            ctx.restore();
            requestAnimationFrame(loop);
        }
    </script>
</body>

</html>